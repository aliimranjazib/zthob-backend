name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
      
      - name: Create deployment script
        run: |
          cat > deploy.sh << 'DEPLOYSCRIPT'
          #!/bin/bash
          set -e
          
          cd /home/zthob-backend
          
          echo "üì• Pulling code..."
          git fetch origin
          git reset --hard origin/main
          
          echo "üîß Checking/Installing uv..."
          # Add common uv locations to PATH first
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          
          # Check if uv is installed in PATH or in venv
          UV_CMD=""
          if command -v uv &> /dev/null; then
            UV_CMD="uv"
          elif [ -f "$HOME/.local/bin/uv" ]; then
            UV_CMD="$HOME/.local/bin/uv"
          elif [ -f ".venv/bin/uv" ]; then
            UV_CMD=".venv/bin/uv"
          else
            echo "Installing uv..."
            # Install uv using the official installer
            curl -LsSf https://astral.sh/uv/install.sh | sh
            # Add both possible locations to PATH
            export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
            # Source the env file if it exists (for sh/bash/zsh)
            if [ -f "$HOME/.local/bin/env" ]; then
              source "$HOME/.local/bin/env"
            fi
            # Also try cargo env
            if [ -f "$HOME/.cargo/env" ]; then
              source "$HOME/.cargo/env"
            fi
            # Check which location uv was installed to
            if [ -f "$HOME/.local/bin/uv" ]; then
              UV_CMD="$HOME/.local/bin/uv"
            elif command -v uv &> /dev/null; then
              UV_CMD="uv"
            else
              echo "‚ùå Error: uv installation failed or not found"
              exit 1
            fi
          fi
          
          # Verify uv is available
          echo "Using uv from: $(which $UV_CMD || echo $UV_CMD)"
          $UV_CMD --version
          
          echo "üì¶ Installing dependencies with uv..."
          # Use uv pip install with explicit python path to ensure it uses the .venv
          $UV_CMD pip install --python .venv/bin/python -r requirements.txt
          
          # Activate virtual environment
          source .venv/bin/activate
          
          # Verify venv is activated and working
          which python
          python --version
          
          echo "üóÑÔ∏è Running migrations..."
          python manage.py migrate --noinput
          
          echo "üìÅ Collecting static files..."
          python manage.py collectstatic --noinput
          
          echo "üîÑ Restarting services..."
          sudo systemctl restart gunicorn
          
          echo "‚è≥ Waiting for service..."
          sleep 3
          
          echo "‚úÖ Deployment complete!"
          DEPLOYSCRIPT
      
      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
        run: |
          scp -P $SSH_PORT deploy.sh $SSH_USER@$SSH_HOST:/tmp/deploy.sh
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "chmod +x /tmp/deploy.sh && /tmp/deploy.sh"
      
      - name: Health check
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
        run: |
          echo "üè• Running health check..."
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "curl -f http://localhost:8000/api/config/version/ || (echo 'Health check failed!' && exit 1)"
          echo "‚úÖ Health check passed!"