name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for git info
    
    - name: Bump version
      run: |
        # Read current version
        CURRENT_VERSION=$(cat VERSION | tr -d '\n')
        echo "Current version: $CURRENT_VERSION"
        
        # Bump patch version (x.y.Z)
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        
        echo "New version: $NEW_VERSION"
        echo "$NEW_VERSION" > VERSION
        
        # Get git info
        COMMIT_HASH=$(git rev-parse --short HEAD)
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        COMMIT_DATE=$(git log -1 --format=%ci)
        
        echo "Version: $NEW_VERSION" >> $GITHUB_STEP_SUMMARY
        echo "Commit: $COMMIT_HASH" >> $GITHUB_STEP_SUMMARY
        echo "Branch: $BRANCH" >> $GITHUB_STEP_SUMMARY
        echo "Date: $COMMIT_DATE" >> $GITHUB_STEP_SUMMARY
    
    - name: Commit version bump
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add VERSION
        git commit -m "Bump version to $(cat VERSION) [skip ci]" || echo "No changes to commit"
        git push origin main || echo "Push failed or no changes"
    
    # Google Cloud authentication is optional - only needed if you set up Workload Identity Federation
    # The server uses ADC directly, so this step is not required for deployment
    # Uncomment these steps if you want to use Workload Identity Federation:
    # - name: Authenticate to Google Cloud
    #   if: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
    #   uses: google-github-actions/auth@v2
    #   with:
    #     workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
    #     service_account: ${{ secrets.SERVICE_ACCOUNT }}
    # 
    # - name: Set up Cloud SDK
    #   if: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
    #   uses: google-github-actions/setup-gcloud@v2
    
    - name: Deploy to server
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        ssh -o StrictHostKeyChecking=no root@69.62.126.95 '
          cd /home/zthob-backend
          sudo mkdir -p /var/backups/zthob
          sudo chown $USER:$USER /var/backups/zthob
          
          if [ -f "db.sqlite3" ]; then
            echo "Creating database backup..."
            cp db.sqlite3 /var/backups/zthob/db_backup_$(date +%Y%m%d_%H%M%S).sqlite3
          fi
          
          echo "Creating code backup..."
          tar -czf /var/backups/zthob/code_backup_$(date +%Y%m%d_%H%M%S).tar.gz --exclude=".git" --exclude="__pycache__" --exclude="*.pyc" .
          
          echo "Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          # Verify new code is pulled
          echo "Verifying latest commit..."
          git log -1 --oneline
          
          # Clear Python cache to ensure new code is loaded
          echo "Clearing Python cache..."
          find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete 2>/dev/null || true
          find . -type f -name "*.pyo" -delete 2>/dev/null || true
          
          echo "Activating virtual environment..."
          source magsk_venv/bin/activate
          
          echo "Installing dependencies..."
          pip3 install -r requirements.txt --upgrade
          
          echo "Running migrations..."
          python3 manage.py migrate --verbosity=2 || {
            echo "ERROR: Migration failed!"
            echo "WARNING: CRITICAL: Database reset is DISABLED for production safety"
            echo "Please manually investigate and fix migration issues"
            echo "DO NOT run reset_database.py in production - it will DELETE all data!"
            exit 1
          }
          
          echo "Checking migration status..."
          python3 manage.py showmigrations
          
          echo "Checking for pending migrations (non-blocking)..."
          python3 manage.py makemigrations --check --dry-run 2>&1 | head -20 || echo "Note: Some apps may have pending migrations"
          
          echo "Verifying database tables..."
          python3 << 'PYEOF'
import sqlite3
try:
    conn = sqlite3.connect('db.sqlite3')
    cursor = conn.cursor()
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
    tables = [row[0] for row in cursor.fetchall()]
    print('All tables found:', len(tables), 'tables')
    required = ['tailors_fabrictype', 'tailors_fabriccategory', 'tailors_fabric', 'tailors_fabricimage', 'tailors_tailorprofile', 'orders_order', 'orders_orderitem', 'deliveries_deliverytracking', 'deliveries_locationhistory']
    missing = [t for t in required if t not in tables]
    if missing:
        print('ERROR: Missing tables:', missing)
    else:
        print('SUCCESS: All required tables exist')
    conn.close()
except Exception as e:
    print('WARNING: Could not verify tables:', str(e))
PYEOF
          
          echo "Collecting static files..."
          python3 manage.py collectstatic --noinput
          
          echo "Verifying new app files exist..."
          if [ -d "apps/deliveries" ]; then
            echo "SUCCESS: deliveries app directory exists"
            ls -la apps/deliveries/ | head -10
          else
            echo "WARNING: deliveries app directory not found"
            echo "Checking if apps directory exists..."
            ls -la apps/ | grep deliveries || echo "deliveries not in apps directory"
          fi
          
          echo "Verifying deliveries is in INSTALLED_APPS..."
          if grep -q "apps.deliveries" zthob/settings.py; then
            echo "SUCCESS: deliveries found in INSTALLED_APPS"
          else
            echo "ERROR: deliveries NOT in INSTALLED_APPS"
          fi
          
          echo "Verifying deliveries URLs are in urls.py..."
          if grep -q "api/deliveries" zthob/urls.py; then
            echo "SUCCESS: deliveries URLs found in urls.py"
          else
            echo "ERROR: deliveries URLs NOT in urls.py"
          fi
          
          echo "Restarting service..."
          # Ensure gunicorn directories exist
          sudo mkdir -p /var/run/gunicorn
          sudo chown root:root /var/run/gunicorn
          sudo chmod 755 /var/run/gunicorn
          sudo mkdir -p /home/zthob-backend/logs
          sudo chown root:root /home/zthob-backend/logs
          sudo chmod 755 /home/zthob-backend/logs
          
          # CRITICAL: Stop service completely and kill all workers
          echo "Stopping gunicorn service completely..."
          sudo systemctl stop gunicorn || true
          # Kill any remaining gunicorn processes
          sudo pkill -9 gunicorn || true
          # Remove stale PID file if it exists
          sudo rm -f /var/run/gunicorn/zthob.pid || true
          # Wait to ensure all processes are killed
          sleep 3
          
          # Now start fresh
          echo "Starting gunicorn service..."
          sudo systemctl start gunicorn
          
          # Wait a moment for service to start
          sleep 5
          
          # Verify service is running and check if new code is loaded
          if systemctl is-active --quiet gunicorn; then
            echo "SUCCESS: Service is running!"
            
            # Wait for API to be ready
            echo "Waiting for API to be ready..."
            sleep 5
            
            # Verify version endpoint
            echo "Verifying deployment version..."
            DEPLOYED_VERSION=$(curl -s http://localhost:8000/api/config/version/ 2>/dev/null | grep -o '\"version\":\"[^\"]*' | cut -d'\"' -f4 || echo "unknown")
            EXPECTED_VERSION=$(cat VERSION 2>/dev/null | tr -d '\n' || echo "unknown")
            
            echo "Expected version: $EXPECTED_VERSION"
            echo "Deployed version: $DEPLOYED_VERSION"
            
            if [ "$DEPLOYED_VERSION" = "$EXPECTED_VERSION" ]; then
              echo "✓ SUCCESS: Version matches! Deployment verified."
            else
              echo "⚠ WARNING: Version mismatch! Expected $EXPECTED_VERSION but got $DEPLOYED_VERSION"
              echo "This might indicate the code wasn't fully updated."
            fi
            
            # Additional verification: Check if new endpoints are available
            echo "Verifying API endpoints..."
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/schema/ | grep -q "200"; then
              echo "✓ SUCCESS: API is responding"
            else
              echo "⚠ WARNING: API might not be fully ready yet"
            fi
            
            echo "SUCCESS: Deployment completed!"
          else
            echo "ERROR: Service failed to start, checking logs..."
            systemctl status gunicorn
            journalctl -u gunicorn --since "1 minute ago"
            echo "Attempting to fix and restart..."
            
            # Fix common issues
            sudo mkdir -p /var/run/gunicorn
            sudo chown root:root /var/run/gunicorn
            sudo chmod 755 /var/run/gunicorn
            # Remove stale PID file
            sudo rm -f /var/run/gunicorn/zthob.pid || true
            
            # Kill all gunicorn processes to ensure clean restart
            sudo pkill -9 gunicorn || true
            sleep 3
            
            # Stop and start again (instead of restart)
            sudo systemctl stop gunicorn || true
            sleep 2
            sudo systemctl start gunicorn
            sleep 5
            
            if systemctl is-active --quiet gunicorn; then
              echo "SUCCESS: Service fixed and running!"
            else
              echo "ERROR: Service still failed after fix attempt"
              exit 1
            fi
          fi
        '
