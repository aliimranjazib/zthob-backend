name: Deploy to Production

on:
  workflow_dispatch:  # Manual trigger only - click "Run workflow" button

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to production environment
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        ssh -o StrictHostKeyChecking=no root@69.62.126.95 '
          cd /home/zthob-backend
          
          echo "ğŸ’¾ Creating production backup..."
          sudo mkdir -p /var/backups/zthob
          sudo chown $USER:$USER /var/backups/zthob
          timestamp=$(date +%Y%m%d_%H%M%S)
          
          # Backup database
          export $(grep -v "^#" .env.production | xargs)
          PGPASSWORD=$DB_PASSWORD pg_dump -U $DB_USER -h localhost mgask > /var/backups/zthob/mgask_backup_${timestamp}.sql || echo "âš ï¸  Database backup failed (might not exist yet)"
          
          # Backup code
          tar -czf /var/backups/zthob/code_backup_${timestamp}.tar.gz \
            --exclude=".git" \
            --exclude="__pycache__" \
            --exclude="*.pyc" \
            --exclude="magsk_venv" \
            --exclude="staticfiles" \
            . || echo "âš ï¸  Code backup warning"
          
          echo "âœ… Backups created at /var/backups/zthob/"
          
          echo "ğŸ“¦ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          echo "ğŸ Activating virtual environment..."
          source magsk_venv/bin/activate
          
          echo "ğŸ“¥ Installing dependencies..."
          pip3 install -r requirements.txt --quiet
          
          echo "ğŸ”§ Loading production environment..."
          export $(grep -v "^#" .env.production | xargs)
          export APP_ENV=production
          
          echo "ğŸ—„ï¸  Running migrations for production..."
          python3 manage.py migrate --verbosity=2 || {
            echo "âŒ ERROR: Migration failed!"
            echo "ğŸ’¡ You can restore from backup at /var/backups/zthob/mgask_backup_${timestamp}.sql"
            exit 1
          }
          
          echo "ğŸ“Š Checking migration status..."
          python3 manage.py showmigrations
          
          echo "ğŸ“ Collecting static files..."
          python3 manage.py collectstatic --noinput
          
          echo "ğŸ”„ Restarting production service..."
          sudo systemctl restart gunicorn-production
          
          echo "â³ Waiting for service to start..."
          sleep 3
          
          if systemctl is-active --quiet gunicorn-production; then
            echo "âœ… PRODUCTION deployment successful!"
            echo "ğŸŒ Production URL: http://prod.mgask.net"
            
            # Test the endpoint
            curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://prod.mgask.net/api/config/version/ || true
          else
            echo "âŒ Production service failed to start"
            echo "ğŸ“‹ Recent logs:"
            sudo journalctl -u gunicorn-production --since "2 minutes ago" --no-pager
            echo ""
            echo "ğŸ’¡ To restore database from backup:"
            echo "   psql -U mgask_user -d mgask < /var/backups/zthob/mgask_backup_${timestamp}.sql"
            exit 1
          fi
        '
